name: Full Integration Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read

jobs:
  integration-test:
    name: Integration Tests on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.10", "3.11", "3.12"]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            python3-tk \
            libopencv-dev \
            libgl1 \
            libegl1-mesa \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender-dev \
            libgomp1
      
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
      
      - name: Verify dependencies
        run: |
          echo "=== Installed Packages ==="
          pip list
          echo ""
          echo "=== Python Version ==="
          python --version
          echo ""
          echo "=== OpenCV Version ==="
          python -c "import cv2; print(f'OpenCV: {cv2.__version__}')"
          echo ""
          echo "=== NumPy Version ==="
          python -c "import numpy; print(f'NumPy: {numpy.__version__}')"
          echo ""
          echo "=== Tkinter Available ==="
          python -c "import tkinter; print('Tkinter: OK')"
      
      - name: Check Python syntax
        run: |
          pip install flake8
          # Check for syntax errors and undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics \
            --exclude=venv,env,.git,__pycache__,.pytest_cache
      
      - name: Validate shell scripts
        run: |
          echo "=== Validating Shell Scripts ==="
          bash -n install_autostart.sh
          bash -n uninstall_autostart.sh
          bash -n start_medical_inventory.sh
          echo "All shell scripts are syntactically valid"
      
      - name: Test database manager
        run: |
          echo "=== Testing Database Manager ==="
          pytest test_db_manager.py -v
      
      - name: Test medical inventory (non-GUI parts)
        continue-on-error: true
        run: |
          echo "=== Testing Medical Inventory ==="
          # Note: GUI tests require DISPLAY and are skipped in CI
          # Run only non-GUI tests if available
          pytest test_medical_inventory.py -v -k "not gui" 2>&1 || echo "No non-GUI tests available"
      
      - name: Validate auto-start setup files
        run: |
          echo "=== Running Auto-Start Validation ==="
          chmod +x test_autostart_setup.sh
          ./test_autostart_setup.sh
      
      - name: Test import of all modules
        run: |
          echo "=== Testing Module Imports ==="
          python -c "import db_manager; print('✓ db_manager imported successfully')"
          python -c "import facial_recognition; print('✓ facial_recognition imported successfully')"
          # Note: medical_inventory requires DISPLAY, so we skip GUI testing
      
      - name: Verify systemd service file structure
        run: |
          echo "=== Validating Systemd Service File ==="
          if grep -q "\[Unit\]" medical-inventory.service && \
             grep -q "\[Service\]" medical-inventory.service && \
             grep -q "\[Install\]" medical-inventory.service; then
            echo "✓ Service file structure is valid"
          else
            echo "✗ Service file structure is invalid"
            exit 1
          fi
      
      - name: Check documentation completeness
        run: |
          echo "=== Checking Documentation ==="
          test -f README.md && echo "✓ README.md exists"
          test -f AUTOSTART_SETUP.md && echo "✓ AUTOSTART_SETUP.md exists"
          test -f RASPBERRY_PI_SETUP.md && echo "✓ RASPBERRY_PI_SETUP.md exists"
          test -f QUICK_START_AUTOBOOT.md && echo "✓ QUICK_START_AUTOBOOT.md exists"
          test -f AUTO_START_SUMMARY.md && echo "✓ AUTO_START_SUMMARY.md exists"
          
          # Check README has required sections
          grep -q "Auto-Start Configuration" README.md && echo "✓ README includes auto-start section"
          grep -q "Raspberry Pi 4" README.md && echo "✓ README mentions Raspberry Pi 4"
      
      - name: Test database operations
        run: |
          echo "=== Testing Database Operations ==="
          python -c "
          from db_manager import DatabaseManager
          import os
          import tempfile
          
          # Create temporary database
          with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as f:
              db_path = f.name
          
          try:
              # Initialize database
              db = DatabaseManager(db_path)
              print('✓ Database initialized')
              
              # Add a scan
              ts = db.add_scan('TEST123', 'TestUser')
              print(f'✓ Scan added at {ts}')
              
              # Retrieve scans
              scans = db.get_all_scans()
              assert len(scans) == 1
              print(f'✓ Retrieved {len(scans)} scan(s)')
              
              # Delete scan
              db.delete_scan(ts, 'TEST123', 'TestUser', 'ADMIN', 'Test deletion')
              print('✓ Scan deleted')
              
              # Check deletion history
              history = db.get_deletion_history()
              assert len(history) == 1
              print(f'✓ Deletion history has {len(history)} entry')
              
              print('✓ All database operations successful')
          finally:
              os.unlink(db_path)
          "
      
      - name: Verify file permissions
        run: |
          echo "=== Checking File Permissions ==="
          test -x install_autostart.sh && echo "✓ install_autostart.sh is executable"
          test -x uninstall_autostart.sh && echo "✓ uninstall_autostart.sh is executable"
          test -x start_medical_inventory.sh && echo "✓ start_medical_inventory.sh is executable"
          test -x test_autostart_setup.sh && echo "✓ test_autostart_setup.sh is executable"
      
      - name: Integration test summary
        if: always()
        run: |
          echo "=== Integration Test Summary ==="
          echo "OS: ${{ matrix.os }}"
          echo "Python: ${{ matrix.python-version }}"
          echo "Status: ${{ job.status }}"
          echo ""
          echo "All integration tests completed!"

  autostart-validation:
    name: Auto-Start Configuration Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate installation script
        run: |
          echo "=== Validating Installation Script ==="
          bash -n install_autostart.sh
          
          # Check for required commands
          grep -q "systemctl enable" install_autostart.sh && echo "✓ Script enables systemd service"
          grep -q "chmod +x" install_autostart.sh && echo "✓ Script sets executable permissions"
      
      - name: Validate uninstallation script
        run: |
          echo "=== Validating Uninstallation Script ==="
          bash -n uninstall_autostart.sh
          
          # Check for required commands
          grep -q "systemctl disable" uninstall_autostart.sh && echo "✓ Script disables systemd service"
          grep -q "systemctl stop" uninstall_autostart.sh && echo "✓ Script stops service"
      
      - name: Validate startup script
        run: |
          echo "=== Validating Startup Script ==="
          bash -n start_medical_inventory.sh
          
          # Check for required functionality
          grep -q "DISPLAY" start_medical_inventory.sh && echo "✓ Script sets DISPLAY variable"
          grep -q "xset q" start_medical_inventory.sh && echo "✓ Script waits for X server"
          grep -q "python3 medical_inventory.py" start_medical_inventory.sh && echo "✓ Script launches application"
      
      - name: Test service file parsing
        run: |
          echo "=== Testing Service File ==="
          # Verify service file has correct structure
          cat medical-inventory.service
          
          # Check required fields
          grep -q "Description=" medical-inventory.service && echo "✓ Has description"
          grep -q "ExecStart=" medical-inventory.service && echo "✓ Has ExecStart"
          grep -q "Restart=" medical-inventory.service && echo "✓ Has restart policy"

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install markdown linter
        run: |
          npm install -g markdownlint-cli
      
      - name: Check markdown files
        continue-on-error: true
        run: |
          markdownlint '*.md' --ignore node_modules || true
      
      - name: Verify documentation structure
        run: |
          echo "=== Checking Documentation Files ==="
          
          # Check all required docs exist
          for file in README.md AUTOSTART_SETUP.md RASPBERRY_PI_SETUP.md \
                      QUICK_START_AUTOBOOT.md AUTO_START_SUMMARY.md; do
            if [ -f "$file" ]; then
              lines=$(wc -l < "$file")
              echo "✓ $file exists ($lines lines)"
            else
              echo "✗ $file missing"
              exit 1
            fi
          done
          
          echo ""
          echo "=== Checking Documentation Content ==="
          
          # Check README has key sections
          grep -q "## About" README.md && echo "✓ README has About section"
          grep -q "## Features" README.md && echo "✓ README has Features section"
          grep -q "## Prerequisites" README.md && echo "✓ README has Prerequisites section"
          grep -q "Raspberry Pi 4" README.md && echo "✓ README mentions Raspberry Pi 4"
          grep -q "Auto-Start" README.md && echo "✓ README mentions Auto-Start"
          
          # Check setup guides have installation instructions
          grep -q "sudo ./install_autostart.sh" AUTOSTART_SETUP.md && \
            echo "✓ AUTOSTART_SETUP.md has installation command"
          grep -q "Raspberry Pi 4" RASPBERRY_PI_SETUP.md && \
            echo "✓ RASPBERRY_PI_SETUP.md covers Raspberry Pi 4"
          
          echo ""
          echo "All documentation checks passed!"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [integration-test, autostart-validation, documentation-check]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "=== Full Integration Test Suite Summary ==="
          echo ""
          echo "Integration Tests: ${{ needs.integration-test.result }}"
          echo "Auto-Start Validation: ${{ needs.autostart-validation.result }}"
          echo "Documentation Check: ${{ needs.documentation-check.result }}"
          echo ""
          
          if [ "${{ needs.integration-test.result }}" = "success" ] && \
             [ "${{ needs.autostart-validation.result }}" = "success" ] && \
             [ "${{ needs.documentation-check.result }}" = "success" ]; then
            echo "✓ All tests passed successfully!"
            exit 0
          else
            echo "✗ Some tests failed"
            exit 1
          fi
