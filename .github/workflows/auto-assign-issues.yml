name: Auto-Assign Issues from Commit

on:
  push:
    branches: ['**']  # Trigger on all branches

permissions:
  issues: write
  contents: read

jobs:
  create-parent-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract issue numbers from commit message
        id: extract_issues
        run: |
          # Get the commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"
          
          # Extract all issue numbers (supports #123, #456, etc.)
          ISSUES=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | sort -u | tr '\n' ' ')
          
          if [ -z "$ISSUES" ]; then
            echo "No issue numbers found in commit message"
            echo "has_issues=false" >> $GITHUB_OUTPUT
          else
            echo "Found issues: $ISSUES"
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          fi
      
      - name: Fetch issue details and create parent issue
        if: steps.extract_issues.outputs.has_issues == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUES: ${{ steps.extract_issues.outputs.issues }}
        run: |
          # Convert space-separated issues to array
          ISSUE_ARRAY=($ISSUES)
          
          # Arrays to store issue details
          declare -a ISSUE_TITLES
          declare -a ISSUE_NUMBERS
          
          # Fetch details for each issue
          for issue in "${ISSUE_ARRAY[@]}"; do
            # Remove the # prefix
            issue_num=${issue#\#}
            
            # Fetch issue details using GitHub API
            echo "Fetching details for issue #$issue_num"
            issue_data=$(gh api repos/${{ github.repository }}/issues/$issue_num 2>/dev/null || echo "")
            
            if [ -n "$issue_data" ]; then
              title=$(echo "$issue_data" | jq -r '.title')
              ISSUE_TITLES+=("$title")
              ISSUE_NUMBERS+=("$issue_num")
              echo "  Title: $title"
            else
              echo "  Warning: Issue #$issue_num not found"
            fi
          done
          
          # Only proceed if we found at least one valid issue
          if [ ${#ISSUE_NUMBERS[@]} -eq 0 ]; then
            echo "No valid issues found, skipping parent issue creation"
            exit 0
          fi
          
          # Generate parent issue title (brief summary)
          if [ ${#ISSUE_NUMBERS[@]} -eq 1 ]; then
            PARENT_TITLE="Implementation of ${ISSUE_TITLES[0]}"
          else
            # Create a concise title summarizing all issues
            PARENT_TITLE="Implementation of ${#ISSUE_NUMBERS[@]} related issues"
          fi
          
          # Build issue body with task list
          ISSUE_BODY="This issue tracks the implementation of related issues mentioned in commit [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})."
          ISSUE_BODY="$ISSUE_BODY\n\n## Sub-Issues\n\n"
          
          for i in "${!ISSUE_NUMBERS[@]}"; do
            ISSUE_BODY="$ISSUE_BODY- [ ] #${ISSUE_NUMBERS[$i]}: ${ISSUE_TITLES[$i]}\n"
          done
          
          ISSUE_BODY="$ISSUE_BODY\n---\n\n**Commit Message:**\n\`\`\`\n$(git log -1 --pretty=%B)\n\`\`\`"
          
          # Create the parent issue
          echo "Creating parent issue: $PARENT_TITLE"
          parent_issue=$(gh issue create \
            --title "$PARENT_TITLE" \
            --body "$ISSUE_BODY" \
            --label "auto-generated" \
            --repo ${{ github.repository }})
          
          echo "Created parent issue: $parent_issue"
          
          # Comment on each sub-issue to link back to parent
          parent_issue_num=$(echo "$parent_issue" | grep -oE '[0-9]+$')
          
          for issue_num in "${ISSUE_NUMBERS[@]}"; do
            echo "Adding comment to issue #$issue_num"
            gh issue comment $issue_num \
              --body "This issue is tracked as a sub-issue in #$parent_issue_num" \
              --repo ${{ github.repository }} || echo "Failed to comment on #$issue_num"
          done
          
          echo "Workflow completed successfully!"
